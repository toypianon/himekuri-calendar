<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>日めくりカレンダー</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="text-center p-4">
        <h1 id="date-display" class="text-4xl md:text-6xl font-bold text-gray-800"></h1>
        <p id="day-of-week-display" class="text-xl md:text-2xl text-gray-600"></p>

        <div class="mt-8">
            <button id="authorize_button" style="display: none;" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Googleアカウントと連携
            </button>
            <button id="signout_button" style="display: none;" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                ログアウト
            </button>
        </div>

        <div id="content" class="mt-4 text-left"></div>
    </div>

    <script src="config.js"></script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
// ===== 完成版JavaScriptコード ここから =====

// --- グローバル変数定義 ---
let tokenClient;
let gapiInited = false;
let gisInited = false;

const authorizeButton = document.getElementById('authorize_button');
const signoutButton = document.getElementById('signout_button');
const contentDiv = document.getElementById('content');
const dateDisplay = document.getElementById('date-display');
const dayOfWeekDisplay = document.getElementById('day-of-week-display');

// --- 日付と時刻の表示 ---
function updateDateTime() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const date = now.getDate();
    const dayIndex = now.getDay();
    const days = ["日", "月", "火", "水", "木", "金", "土"];

    dateDisplay.textContent = `${year}年 ${month}月${date}日`;
    dayOfWeekDisplay.textContent = `(${days[dayIndex]})`;
}

// --- Google API 関連 ---

// gapi.clientライブラリの読み込み完了時に呼ばれる
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

// gapi.clientの初期化
async function initializeGapiClient() {
    try {
        await gapi.client.init({
            apiKey: config.apiKey,
            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
        });
        gapiInited = true;
        maybeEnableButtons();
    } catch (err) {
        contentDiv.innerText = `エラー: gapi.clientの初期化に失敗しました。 ${err.message}`;
    }
}

// Google認証ライブラリの読み込み完了時に呼ばれる
function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: config.clientId,
        scope: "https://www.googleapis.com/auth/calendar.readonly",
        callback: tokenCallback,
    });
    gisInited = true;
    maybeEnableButtons();
}

// 認証ボタンを有効化する
function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        authorizeButton.style.display = 'block';
    }
}

// 認証ボタンのクリックイベント
authorizeButton.onclick = function handleAuthClick() {
    tokenClient.requestAccessToken({ prompt: 'consent' });
};

// ログアウトボタンのクリックイベント
signoutButton.onclick = function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token, () => {
            gapi.client.setToken(null);
            contentDiv.innerHTML = '';
            authorizeButton.style.display = 'block';
            signoutButton.style.display = 'none';
        });
    }
};

// 認証後のコールバック関数
function tokenCallback(tokenResponse) {
    if (tokenResponse && tokenResponse.access_token) {
        gapi.client.setToken(tokenResponse);
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        listUpcomingEvents();
    } else if (tokenResponse.error) {
        contentDiv.innerText = `エラー: 認証に失敗しました。 ${tokenResponse.error}`;
    }
}

// 今日の予定を取得して表示する
async function listUpcomingEvents() {
    let response;
    try {
        const now = new Date();
        const timeMin = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).toISOString();
        const timeMax = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).toISOString();
        
        response = await gapi.client.calendar.events.list({
            'calendarId': 'primary',
            'timeMin': timeMin,
            'timeMax': timeMax,
            'showDeleted': false,
            'singleEvents': true,
            'orderBy': 'startTime',
        });
    } catch (err) {
        contentDiv.innerText = `エラー: APIリクエストに失敗しました。 ${err.message}`;
        return;
    }

    const events = response.result.items;
    if (!events || events.length == 0) {
        contentDiv.innerText = '今日の予定はありません。';
        return;
    }

    // 古い予定をクリア
    contentDiv.innerHTML = '';

    // 新しい予定をリスト表示
    events.forEach(event => {
        let when;
        if (event.start.dateTime) {
            when = new Date(event.start.dateTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        } else {
            when = '終日';
        }
        const eventElement = document.createElement('p');
        eventElement.textContent = `${when} - ${event.summary}`;
        contentDiv.appendChild(eventElement);
    });
}

// --- 初期化処理 ---

// 日付と時刻を最初に表示し、1秒ごとに時刻を更新
updateDateTime();
setInterval(updateDateTime, 1000);

// GoogleのAPIライブラリを読み込むためのコールバック関数をグローバルに設定
// HTMLの<script src="https://apis.google.com/js/api.js?onload=gapiLoaded">で呼ばれます
window.gapiLoaded = gapiLoaded;
// HTMLの<script src="https://accounts.google.com/gsi/client?onload=gisLoaded">で呼ばれます
window.gisLoaded = gisLoaded;

// ===== 完成版JavaScriptコード ここまで =====
    </script>

</body>
</html>